# Use AWS Lambda Python 3.11 base image
FROM public.ecr.aws/lambda/python:3.11

# Set environment variables for Lambda optimization
ENV DEEPFACE_HOME=/tmp
ENV TF_CPP_MIN_LOG_LEVEL=2
ENV CUDA_VISIBLE_DEVICES=-1
ENV DEEPFACE_FORCE_DOWNLOAD=false
ENV DEEPFACE_VERIFY_WEIGHTS=false
ENV DEEPFACE_DOWNLOAD_WEIGHTS=false
ENV DEEPFACE_WEIGHTS_PATH=/var/task/.deepface/weights
ENV PYTHONUNBUFFERED=1

# Copy requirements first for better caching
COPY requirements_lambda.txt ${LAMBDA_TASK_ROOT}

# Install system dependencies and Python packages in a single layer
RUN yum update -y && \
    yum install -y \
    cmake \
    mesa-libGL \
    mesa-libGLU \
    libstdc++ \
    libgomp \
    libXext \
    libSM \
    libXrender \
    gcc \
    gcc-c++ \
    openblas-devel \
    lapack-devel \
    blas-devel \
    ffmpeg-devel \
    libjpeg-devel \
    libpng-devel \
    libtiff-devel \
    hdf5-devel \
    python3-devel \
    pkgconfig \
    && yum clean all \
    && rm -rf /var/cache/yum \
    && pip install --upgrade pip setuptools wheel \
    && pip install --no-cache-dir -r ${LAMBDA_TASK_ROOT}/requirements_lambda.txt \
    && pip install --no-cache-dir boto3 \
    && mkdir -p /tmp && chmod 777 /tmp \
    && mkdir -p /var/task/.deepface/weights

# Copy function code
COPY main.py ${LAMBDA_TASK_ROOT}

# Copy DeepFace weights to persistent location
COPY .deepface/weights/ /var/task/.deepface/weights/

# Set the CMD to your handler
CMD [ "main.lambda_handler" ]